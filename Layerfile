# Use an Ubuntu 18.04 base for our staging server
FROM vm/ubuntu:18.04

# To note: Layerfiles create entire VMs, *not* containers!

# Install python and certbot
RUN apt-get update && apt-get install -y python3 certbot

# Create some files
RUN echo '<b>some html</b>' > hello.html
RUN echo '<b>another file</b>' > another.html

# This line copies the repository to /root in the runner
COPY . .
RUN ls

# Obtain SSL certificate using certbot
RUN certbot certonly --standalone -d zombopolis.onwebapp.io --non-interactive --agree-tos -m wmckenzie2022@outlook.com

# Configure HTTPS using the obtained certificate
RUN mkdir -p /etc/ssl/certs /etc/ssl/private
RUN cp /etc/letsencrypt/live/zombopolis.onwebapp.io/fullchain.pem /etc/ssl/certs/
RUN cp /etc/letsencrypt/live/zombopolis.onwebapp.io/privkey.pem /etc/ssl/private/

# Start the HTTPS server
RUN BACKGROUND python3 -m http.server --bind 0.0.0.0 --directory /root/ --certfile /etc/ssl/certs/fullchain.pem --keyfile /etc/ssl/private/privkey.pem 443
EXPOSE WEBSITE https://localhost:443
